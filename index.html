<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Temperature Log Dashboard</title>
    <link rel="icon" type="image/png" href="./assets/chart.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827;
        }
        .toast {
            visibility: hidden;
            min-width: 250px;
            margin-left: -125px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 8px;
            padding: 16px;
            position: fixed;
            z-index: 1000;
            left: 50%;
            bottom: 30px;
            font-size: 17px;
            opacity: 0;
            transition: opacity 0.5s, bottom 0.5s;
        }
        .toast.show {
            visibility: visible;
            opacity: 1;
            bottom: 50px;
        }
        /* Custom scrollbar for the log box */
        #log-container::-webkit-scrollbar {
            width: 8px;
        }
        #log-container::-webkit-scrollbar-track {
            background: #374151; /* gray-700 */
            border-radius: 4px;
        }
        #log-container::-webkit-scrollbar-thumb {
            background: #4b5563; /* gray-600 */
            border-radius: 4px;
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex items-start justify-center min-h-screen">

<div class="w-full max-w-6xl mx-auto m-10 p-8 bg-gray-800 rounded-2xl shadow-2xl border border-gray-700">
    <h1 class="text-3xl font-bold text-gray-100 mb-6 border-b border-gray-700 pb-3">Temperature Log Dashboard</h1>

    <div class="flex flex-col md:flex-row md:space-x-4 mb-6">
        <!-- File Selection Button -->
        <div class="flex-grow w-full md:w-auto mb-4 md:mb-0">
            <button id="select-file-btn" class="w-full flex items-center justify-center space-x-2 bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors shadow-md disabled:bg-gray-500">
                <i class="fa-solid fa-database text-xl"></i>
                <span id="select-file-text">Select Backup Database (.db)</span>
            </button>
            <p id="selected-file-path" class="text-xs text-gray-400 mt-1 truncate h-4">No file loaded.</p>
        </div>

        <!-- Export CSV Button (Disabled until data is loaded) -->
        <div class="w-full md:w-auto">
            <button id="export-csv-btn" disabled class="w-full flex items-center justify-center space-x-2 bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors shadow-md disabled:bg-gray-500">
                <i class="ml-1 fa-solid fa-file-csv text-xl"></i>
                <span id="export-csv-text">Export Loaded Data to CSV</span>
            </button>
        </div>
    </div>

    <!-- Data Table Container -->
    <div class="mt-6">
        <div class="flex justify-between items-center mb-3">
            <h2 class="text-xl font-semibold text-gray-100">Log Data Preview (<span id="row-count">0</span> records)</h2>
        </div>

        <div id="log-container" class="bg-gray-700 p-4 rounded-lg h-[60vh] overflow-y-auto text-sm border border-gray-600">
            <table class="min-w-full text-left">
                <thead>
                <tr class="border-b-2 border-gray-500 sticky top-0 bg-gray-700 z-10">
                    <th class="py-2 pr-4 font-medium w-12">SL</th>
                    <th class="py-2 pr-4 font-medium w-40">Sensor</th>
                    <th class="py-2 pr-4 font-medium w-24">Status</th>
                    <th class="py-2 pr-4 font-medium w-24">Temp (Â°C)</th>
                    <th class="py-2 font-medium w-40">Time Stamp</th>
                </tr>
                </thead>
                <tbody class="font-normal text-sm" id="log-body">
                    <tr class="text-gray-400">
                        <td colspan="5" class="text-center py-8">Select a .db file using the button above to load log data.</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<div id="toast" class="toast"></div>

<script>
    const selectFileBtn = document.getElementById('select-file-btn');
    const selectFileText = document.getElementById('select-file-text');
    const selectedFilePath = document.getElementById('selected-file-path');
    const exportCsvBtn = document.getElementById('export-csv-btn');
    const exportCsvText = document.getElementById('export-csv-text');
    const logBody = document.getElementById('log-body');
    const rowCountSpan = document.getElementById('row-count');
    const toastElement = document.getElementById('toast');
    
    // Global variable to hold the currently loaded data (for CSV export)
    let loadedLogData = []; 

    /**
     * Display a temporary notification (toast).
     * @param {string} message - The message to display.
     */
    function showToast(message) {
        toastElement.textContent = message;
        toastElement.className = "toast show";
        setTimeout(() => {
            toastElement.className = toastElement.className.replace("show", "");
        }, 3000);
    }

    /**
     * Renders the log data array into the HTML table.
     * @param {Array<Object>} data - Array of log objects.
     */
    function renderLogTable(data) {
        logBody.innerHTML = '';
        loadedLogData = data;
        rowCountSpan.textContent = data.length;

        if (data.length === 0) {
            logBody.innerHTML = `<tr class="text-gray-400"><td colspan="5" class="text-center py-8">No log entries found in this database file.</td></tr>`;
            exportCsvBtn.disabled = true;
            return;
        }

        data.forEach(entry => {
            const status = entry.status;
            const rowClass = status === 'High' ? 'text-red-400 font-medium' : 'text-gray-300';
            
            const newRow = logBody.insertRow(-1); // Insert at the end
            newRow.className = rowClass + ' border-b border-gray-700 hover:bg-gray-600 transition-colors';

            const slCell = newRow.insertCell(0);
            const sensorCell = newRow.insertCell(1);
            const statusCell = newRow.insertCell(2);
            const tempCell = newRow.insertCell(3);
            const dateCell = newRow.insertCell(4);

            slCell.textContent = entry.sl;
            sensorCell.textContent = entry.sensor_name;
            statusCell.textContent = status;
            tempCell.textContent = entry.temperature === null ? '---' : entry.temperature;
            dateCell.textContent = entry.timestamp;

            // Apply padding
            [slCell, sensorCell, statusCell, tempCell, dateCell].forEach(cell => {
                cell.classList.add('py-2', 'pr-4');
            });
        });
        
        exportCsvBtn.disabled = false;
    }

    // --- Event Listeners ---

    // 1. Select Database File
    selectFileBtn.addEventListener('click', async () => {
        if (!window.api || !window.api.loadDatabaseLog) {
            showToast("IPC Bridge not ready. Cannot select file.");
            return;
        }
        
        selectFileBtn.disabled = true;
        selectFileText.textContent = "Opening File Dialog...";
        
        try {
            const response = await window.api.loadDatabaseLog();

            if (response.success) {
                selectedFilePath.textContent = response.filePath;
                selectFileText.textContent = "File Loaded Successfully";
                renderLogTable(response.data);
                showToast(`Loaded ${response.data.length} records from ${response.fileName}`);
            } else if (response.message === 'Canceled') {
                selectFileText.textContent = "Select Backup Database (.db)";
                showToast("File selection canceled.");
            } else {
                selectFileText.textContent = "Error Loading File";
                selectedFilePath.textContent = response.message;
                renderLogTable([]);
                showToast(`Error: ${response.message}`);
            }
        } catch (error) {
            console.error("Dashboard IPC Error:", error);
            selectFileText.textContent = "Critical IPC Error";
            selectedFilePath.textContent = error.message;
            renderLogTable([]);
            showToast("A critical error occurred.");
        } finally {
            selectFileBtn.disabled = false;
        }
    });

    // 2. Export to CSV
    exportCsvBtn.addEventListener('click', async () => {
        if (!window.api || !window.api.exportToCSV) {
            showToast("IPC Bridge not ready. Cannot export.");
            return;
        }
        if (loadedLogData.length === 0) {
            showToast("No data loaded to export.");
            return;
        }

        exportCsvBtn.disabled = true;
        exportCsvText.textContent = 'Exporting...';
        showToast("Requesting CSV export...");

        try {
            const response = await window.api.exportToCSV(loadedLogData);
            
            if (response.success) {
                showToast(response.message);
            } else if (response.message !== 'Canceled') {
                showToast(`CSV Export Failed: ${response.message}`);
            }
        } catch (error) {
            console.error("CSV Export IPC Error:", error);
            showToast(`Export failed: ${error.message}`);
        } finally {
            exportCsvBtn.disabled = false;
            exportCsvText.textContent = 'Export Loaded Data to CSV';
        }
    });

    // Initial state setup
    document.addEventListener('DOMContentLoaded', () => {
        // Ensure the file path displays correctly on mobile/small screens
        if (window.api && window.api.getInitialBackupPath) {
            window.api.getInitialBackupPath().then(initialPath => {
                selectedFilePath.title = initialPath;
                selectedFilePath.textContent = `Default Backup Dir: ${initialPath}`;
            });
        }
    });
</script>
</body>
</html>
